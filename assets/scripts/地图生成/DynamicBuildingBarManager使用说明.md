# 动态建筑栏管理器使用说明

## 概述

`DynamicBuildingBarManager` 是一个新的建筑栏管理器，它可以根据配置文件动态生成建筑节点，而不是使用固定的节点。这个管理器支持：

- 根据 `building-config (3).json` 配置文件动态加载建筑
- 自动映射建筑尺寸到对应的预制体（如 `Tile_1-1.prefab`, `Tile_2-2.prefab` 等）
- 在建筑栏中显示固定尺寸的预览图标
- 与现有的 `BuildingPlacer` 和 `BuildInfo` 系统完全兼容

## 设置步骤

### 1. 添加组件到场景

1. 在场景中创建一个空节点，命名为 `DynamicBuildingBarManager`
2. 为该节点添加 `DynamicBuildingBarManager` 组件

### 2. 配置组件属性

在 `DynamicBuildingBarManager` 组件中设置以下属性：

#### 必需属性：
- **Building Bar Container**: 建筑栏容器节点（用于放置动态生成的建筑图标）
- **Building Placer**: 建筑放置器组件的引用
- **Building Prefabs**: 建筑预制体数组，按尺寸命名

#### 可选属性：
- **Preview Icon Width**: 预览图标宽度（默认150）
- **Preview Icon Height**: 预览图标高度（默认150）
- **Icon Spacing**: 图标间距（默认10）

### 3. 准备建筑预制体

确保你的建筑预制体按照以下规则命名和组织：

```
预制体/建筑/
├── Tile_1-1.prefab    // 1x1 尺寸建筑
├── Tile_2-1.prefab    // 2x1 尺寸建筑
├── Tile_2-2.prefab    // 2x2 尺寸建筑
├── Tile_3-3.prefab    // 3x3 尺寸建筑
└── ...
```

**重要**: 每个预制体必须包含 `BuildInfo` 组件，并正确设置宽度和高度属性。

### 4. 配置建筑数据

确保 `building-config (3).json` 文件包含正确的建筑配置：

```json
{
  "buildings": [
    {
      "name": "香樟树",
      "type": "装饰",
      "unlockPopularity": 0,
      "width": 1,
      "height": 1,
      "image": "香樟树.png",
      "decorationValue": 5,
      "charmValue": 3,
      "chainBuildings": []
    }
    // ... 更多建筑配置
  ]
}
```

### 5. 设置建筑图片资源

将建筑图片放置在 `resources/建筑/` 目录下，确保图片名称与配置文件中的 `image` 字段匹配。

## 工作原理

### 初始化流程

1. **预制体映射**: 系统根据预制体中 `BuildInfo` 的宽度和高度创建映射表
2. **配置加载**: 从 `building-config (3).json` 加载建筑配置
3. **节点创建**: 为每个建筑配置创建对应的预制体实例
4. **尺寸调整**: 将预制体调整为固定的预览尺寸
5. **图片加载**: 加载并设置建筑预览图片
6. **布局更新**: 在建筑栏中排列所有建筑图标

### 交互流程

1. **点击检测**: 监听全局触摸事件，检测建筑图标点击
2. **建筑选择**: 选中建筑并提供视觉反馈
3. **信息传递**: 将 `BuildInfo` 传递给 `BuildingPlacer`
4. **放置处理**: `BuildingPlacer` 处理建筑放置逻辑
5. **状态重置**: 放置完成后重置选择状态

## 与原系统的区别

### 原系统（固定节点）
- 需要手动在场景中创建每个建筑节点
- 建筑数量和类型固定
- 难以维护和扩展
- 场景文件体积大

### 新系统（动态生成）
- 根据配置文件自动生成建筑节点
- 支持动态添加/删除建筑类型
- 易于维护和扩展
- 场景文件体积小
- 支持预制体复用

## 预制体要求

每个建筑预制体必须满足以下要求：

1. **包含 BuildInfo 组件**: 用于存储建筑信息
2. **正确的尺寸设置**: BuildInfo 中的 width 和 height 必须正确
3. **包含 Sprite 组件**: 用于显示建筑图片（可以在子节点中）
4. **合理的节点结构**: 支持缩放调整以适应预览尺寸

## 自定义和扩展

### 添加新建筑类型

1. 创建对应尺寸的预制体（如果不存在）
2. 在 `building-config (3).json` 中添加建筑配置
3. 添加建筑图片到 `resources/建筑/` 目录
4. 调用 `reloadBuildings()` 方法刷新建筑栏

### 自定义预览样式

可以通过修改以下方法来自定义预览样式：
- `adjustNodeSizeForPreview()`: 调整预览尺寸
- `setBuildingNodeSelected()`: 自定义选中效果
- `updateBuildingBarLayout()`: 自定义布局方式

### 事件监听

可以监听以下事件来扩展功能：
- 建筑选择事件
- 建筑放置事件
- 配置重载事件

## 故障排除

### 常见问题

1. **建筑图标不显示**
   - 检查预制体是否正确设置
   - 检查 BuildInfo 组件是否存在
   - 检查配置文件格式是否正确

2. **图片加载失败**
   - 检查图片路径是否正确
   - 检查图片是否在 `resources/建筑/` 目录下
   - 检查图片格式是否支持

3. **尺寸映射失败**
   - 检查预制体命名是否符合 `Tile_宽度-高度.prefab` 格式
   - 检查 BuildInfo 中的宽度和高度设置

4. **点击无响应**
   - 检查 BuildingPlacer 引用是否正确
   - 检查操作状态是否允许建筑放置
   - 检查触摸事件是否被其他组件拦截

### 调试信息

系统会在控制台输出详细的调试信息，包括：
- 预制体映射结果
- 建筑配置加载状态
- 节点创建过程
- 图片加载结果
- 用户交互事件

通过查看这些信息可以快速定位问题。

## 性能优化建议

1. **预制体优化**: 保持预制体结构简单，避免过多的子节点
2. **图片优化**: 使用合适的图片格式和尺寸
3. **缓存机制**: 系统已实现预制体映射缓存
4. **按需加载**: 考虑实现分页或按需加载大量建筑

## 迁移指南

从原有的固定节点系统迁移到动态系统：

1. 备份原有场景文件
2. 移除场景中的固定建筑节点
3. 添加 `DynamicBuildingBarManager` 组件
4. 配置预制体数组和其他属性
5. 测试所有建筑类型的显示和放置功能
6. 根据需要调整预览尺寸和布局

通过以上步骤，你就可以成功使用动态建筑栏管理器来替代原有的固定节点方式，获得更好的可维护性和扩展性。